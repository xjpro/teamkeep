@{
    Layout = "~/Views/Shared/Master.cshtml";
    ViewBag.Title = "Password Reset";
    ViewBag.Description = "Reset your password";
}

<div id="reset" class="container main">
    <div class="row">
        <div class="span6">
            <form class="form-horizontal" data-bind="submit: Reset">
                <h1>Reset your password</h1>

                <div id="reset-alert" class="alert alert-error hide">
                </div>

                <div class="control-group">
                    <label class="control-label">Username</label>
                    <div class="controls">
                        <input type="text" data-bind="value: Username"/>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label">New password</label>
                    <div class="controls">
                        <input type="password" placeholder="Your new password" data-bind="value: NewPassword"/>
                    </div>
                </div>

                <div class="control-group">
                    <div class="controls">
                        <button class="btn btn-success">
                            <i class="icon-spinner icon-spin"></i> Reset password
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    var ResetViewModel = function (data) {
        var me = this;
        ko.mapping.fromJS(data, {}, me);

        this.NewPassword = ko.observable("");
        this.Reset = function () {
            $("button").prop("disabled", true);
            $("button .icon-spin").show();
            $("#reset-alert").hide();
            $.ajax({
                type: "PUT", url: "/users/password",
                data: JSON.stringify({
                    Username: me.Username(),
                    ResetToken: me.ResetToken(),
                    Password: me.NewPassword()
                }),
                contentType: "application/json",
                success: function (response) {
                    TeamKeep.signIn(response.AuthToken, response.Redirect);
                },
                error: function (response) {
                    $("#reset-alert").html(JSON.parse(response.responseText)).show();
                    $("button").prop("disabled", false);
                    $("button .icon-spin").hide();
                }
            });
        };
    };

    var username = location.search.match(/username=([^&]*)/i);
    var resetHash = location.search.match(/token=([^&]*)/i);

    var resetViewData = {
        Username: (username) ? username[1] : "",
        ResetToken: (resetHash) ? resetHash[1] : ""
    };

    window.viewModel = ko.mapping.fromJS(resetViewData, ko.mapping.toViewModel(ResetViewModel));
    ko.applyBindings(window.viewModel, document.getElementById("reset"));
</script>
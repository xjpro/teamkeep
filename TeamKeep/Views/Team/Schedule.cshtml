@model TeamKeep.Models.ViewModels.TeamViewModel

<div class="table-container stacks" ng-controller="ScheduleController">
    <div class="table-controls">
        <div class="column-select pull-left">
            <div class="btn-group">
                <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                    Columns <span class="caret"></span>
                </a>
                <ul class="dropdown-menu" data-bind="foreach: Columns">
                    <li ng-repeat="column in columns" ng-show="column.toggleable">
                        <a ng-class="{active: column.visible}" ng-click="column.visible = !column.visible">
                            {{column.toggleName || column.name}}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="season-select pull-right" ng-if="editable">
            <i class="icon-refresh icon-spin" style="display: none"></i> 
            <button class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                <i class="icon-plus-sign-alt"></i> Game
            </button>
            <ul class="dropdown-menu">
                <li><label class="heading">Add to &mdash;</label></li>
                <li class="divider"></li>
                <li ng-repeat="season in seasons">
                    <a tabindex="-1" data-bind="click: function() { $root.AddGame(Id()); }">{{season.Name}}</a>
                </li>
                <li><a tabindex="-1" data-bind="click: function() { AddGame(); }">New season</a></li>
            </ul>
        </div>
        <div style="clear: both;"></div>
    </div>
    <table>
        <thead>
            <tr>
                <th ng-class="column.cssClass" ng-show="column.visible" ng-repeat="column in columns">
                    <a title="{{column.toolTip}}" sorttype="{{column.sortType}}">{{column.name}}</a>
                </th>
            </tr>
        </thead>
        <tbody ng-hide="seasons.length > 0">
            <tr>
                <td class="fullinfo" colspan="8">
                    No games have been posted for this team
                </td>
            </tr>
        </tbody>
        <tbody ng-repeat="season in seasons">
            <tr>
                <td class="fullheading" colspan="8">
                    <input class="mod" type="text" data-bind="value: Name, editable: $parent.Editable, event: { focus: Selected, change: Update } "/>
                    <div class="options pull-right" ng-if="editable">
                        <i class="icon-circle-arrow-up" title="Move season up" ng-show="season.Order != 0" data-bind="click: function() { IncrementOrder(-1); }"></i>
                        <i class="icon-circle-arrow-down" title="Move season down" ng-show="season.Order != seasons.length-1" data-bind="click: function() { IncrementOrder(1); }"></i>
                        <i class="icon-trash" title="Delete season" data-toggle="modal" data-target="#season-delete-modal" data-bind="click: Selected"></i>
                    </div>
                </td>
            </tr>

            <tr ng-hide="season.Games.length > 0">
                <td class="fullinfo" colspan="7">There are no games in this season</td>
            </tr>

            <tr ng-repeat="game in season.Games">
                <td class="button" ng-show="columns[0].visible">
                    <a id="dropLabel" class="dropdown-toggle" role="button" data-toggle="dropdown" data-target="#"><i class="icon-edit"></i></a>
                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropLabel">
                        <li class="dropdown-submenu">
                            <a tabindex="-1">Move to</a>
                            <ul class="dropdown-menu">
                                <li ng-repeat="moveSeason in seasons" ng-hide="moveSeason == season">
                                    <a tabindex="-1" data-bind="click: function() { $parent.MoveGame($data, $element); }">{{moveSeason.Name}}</a>
                                </li>
                                <li class="divider" ng-if="season.length > 1"></li>
                                <li>
                                    <a tabindex="-1" data-bind="click: function() {  MoveGameToNewSeason($element); }">New season</a>
                                </li>
                            </ul>
                        </li>
                        <!--li><a tabindex="-1" data-bind="">Mark as cancelled</a></!--li-->
                        <li><a tabindex="-1" data-bind="click: RemoveGame">Remove</a></li>
                    </ul>
                </td>
                <td class="date" ng-switch on="isMobile" ng-show="columns[1].visible">
                    <input class="mod" type="datetime-local" ng-switch-when="true" ng-model="game.DateTime" data-bind="value: DateTime, editable: $parents[1].Editable, event: { change: Update }"/>
                    <input class="mod" type="text" ng-switch-default ng-model="game.DateTime" data-bind="value: DateTime, editable: $parents[1].Editable, event: { focus: EnableDateInput }"/>
                </td>
                <td class="hometeam-points digit" ng-show="columns[2].visible">
                    <input class="mod" type="text" ng-model="game.ScoredPoints" />
                </td>
                <td class="awayteam-points digit" ng-show="columns[3].visible">
                    <input class="mod" type="text" ng-model="game.AllowedPoints" />
                </td>
                <td class="tiepoints digit" ng-show="columns[4].visible">
                    <input class="mod" type="text" ng-model="game.TiePoints" />
                </td>
                <td class="max">
                    <input class="mod" type="text" ng-model="game.OpponentName" />
                </td>
                <td class="location" ng-show="columns[6].visible">
                    <input class="mod" type="text" locid="{{game.Location.Id}}" data-bind="value: LocationDisplay, enable: $parents[1].Editable() || LocationEditorEligible(), attr: { locid: Location.Id }" readonly="readonly" />
                    <div class="editor">
                        <div ng-if="editable || game.Location.Description">
                            <label>Name</label>
                            <input type="text" class="js-desc" data-bind="value: Location.Description, editable: $parents[1].Editable, event: { change: Update }"/>
                        </div>
                        <div ng-if="editable || game.Location.Street">
                            <label>Street</label>
                            <input type="text" class="js-street" ng-model="game.Location.Street" />
                        </div>
                        <div ng-if="editable || game.Location.City">
                            <label>City</label>
                            <input type="text" class="js-city" ng-model="game.Location.City" />
                        </div>
                        <div ng-if="editable || game.Location.Postal">
                            <label>Zip</label>
                            <input type="text" class="js-postal" ng-model="game.Location.Postal" />
                        </div>
                        <div>
                            <button class="btn pull-right">Done</button>
                        </div>
                    </div>
                </td>
                <td class="sublocation" ng-show="columns[7].visible">
                    <input class="mod" type="text" ng-model="game.Location.InternalLocation" />
                </td>
            </tr>            
        </tbody>
    </table>
</div>

<div id="season-delete-modal" class="modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Are you sure?</h3>
    </div>
    <div class="modal-body">
        <p>Deleting this season will also remove all the games it contains.</p>
        <p>This cannot be undone.</p>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button class="btn btn-primary" data-dismiss="modal" data-bind="click: $root.RemoveSelectedSeason">Yes, please delete</button>
    </div>
</div>

<script>
    $(function() {
        // Location editor
        $("#schedule tbody").on("click focus", "td.location > input.mod", function(evt) {
            evt.stopPropagation();

            if (evt.type === "focusin" && $(evt.target).attr("locid") && $(".editor:visible").length > 0) {
                $(this).closest("tr").find("td.max input").focus();
                return;
            }

            var clicked = $(this);
            var editor = clicked.parent().find(".editor");
            if ($(window).width() > 690) {
                editor.css({
                    position: "absolute",
                    top: clicked.position().top - editor.outerHeight(),
                    left: clicked.position().left - editor.outerWidth() / 2,
                    marginLeft: "0"
                });
            } else {
                editor.css({
                    position: "fixed",
                    top: "10px",
                    left: "50%",
                    marginLeft: "-" + editor.outerWidth() / 2 + "px"
                });
            }

            editor.show().children("input:first").focus();

            $(window).bind("mouseup.editor keyup.editor", function(docEvt) {
                docEvt.stopPropagation();
                var target = $(docEvt.target);
                if (target.hasClass("editor") || target.attr("locid") === clicked.attr("locid")) return;
                if (docEvt.which === 27 || editor.find(":focus").length === 0) {
                    editor.fadeOut("fast");
                    $(window).unbind(".editor");
                }
            });
            $(window).bind("resize.editor", function() {
                editor.fadeOut("fast");
                $(window).unbind(".editor");
            });
            editor.find("button").one("click.editor", function() { // TODO can this trigger multple?
                editor.fadeOut("fast");
                $(window).unbind(".editor");
            });
        });

        // Tabbing off the end of the table creates a new entry 
        $("#schedule tbody").on("keydown", "tr:last > td:last input", function(evt) {
            evt.stopImmediatePropagation();
            if (evt.keyCode === 9 && !evt.shiftKey) {
                evt.preventDefault();
                teamScheduleViewModel.AddGame(-1);
            }
        });
    });
</script>